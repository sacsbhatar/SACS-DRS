<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Anjani Courier - Cloud Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --primary: #f37021; --secondary: #2196F3; --danger: #ff4d4d; --success: #4CAF50; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #ecf0f1; text-transform: uppercase; }
        input, select { text-transform: uppercase; }

        .top-info { background: var(--dark); color: white; padding: 12px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .top-info input, .top-info select { padding: 8px; border-radius: 4px; border: 1px solid #555; width: 180px; background: #34495e; color: white; }

        .no-print { padding: 12px; text-align: center; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .page-break { width: 210mm; height: 297mm; padding: 8mm 10mm; margin: 15px auto; background: white; box-sizing: border-box; border: 1px solid #ccc; page-break-after: always; overflow: hidden; position: relative; }
        
        .header-section { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 5px; }
        .logo-main { font-size: 28px; font-weight: bold; font-style: italic; line-height: 1; }
        .logo-sub { font-size: 13px; font-weight: bold; border-top: 2px solid #000; display: inline-block; margin-top: 2px; }
        
        .addr-line { font-size: 10px; font-weight: normal; display: block; margin-top: 1px; }
        .addr-bold { font-size: 10.5px; font-weight: bold; display: block; margin-top: 1px; }

        .drs-info { width: 42%; font-size: 13px; line-height: 1.4; }
        .drs-title { font-weight: bold; font-size: 18px; text-decoration: underline; margin-bottom: 2px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1.5px solid #000; padding: 4px 6px; text-align: left; overflow: hidden; }
        th { background-color: #f2f2f2; font-size: 11px; text-align: center; height: 25px; }
        td { height: 50px; font-size: 13.5px; font-weight: bold; position: relative; word-wrap: break-word; }
        
        .col-no { width: 30px; text-align: center; }
        .col-awb { width: 130px; text-align: center; }
        .col-sign { width: 250px; }

        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 400px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); position: relative; border-top: 8px solid var(--primary); }
        
        .btn { padding: 10px 18px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; color: white; font-size: 13px; transition: 0.3s; }

        @media print {
            .no-print, .modal, .top-info, .row-actions, .search-icon-btn { display: none !important; }
            .page-break { margin: 0; border: none; width: 100%; box-shadow: none; padding: 8mm 10mm; height: 297mm; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<div class="top-info">
    DATE: <input type="date" id="drsDatePicker" onchange="updateDrsDate(this.value)" style="width:140px;">
    BOY: <input type="text" id="deliveryBoy" list="boyList" placeholder="NAME" oninput="renderTable()">
    <datalist id="boyList"></datalist>

    AREA: <input type="text" id="areaName" list="areaList" placeholder="AREA" oninput="renderTable()">
    <datalist id="areaList"></datalist>
</div>

<div class="no-print">
    <button class="btn" style="background: var(--secondary);" onclick="validateAndOpenDoc()">+ ADD DOC</button>
    <button id="saveBtn" class="btn" style="background: var(--success);" onclick="saveToCloud()">â˜ï¸ SAVE TO GOOGLE SHEET</button>
    <button class="btn" style="background: var(--primary);" onclick="window.print()">ğŸ–¨ï¸ PRINT</button>
    <button class="btn" style="background: #e67e22;" onclick="openMasterModal()">âš™ï¸ MASTER</button>
    <button class="btn" style="background: #546e7a;" onclick="openAddrModal()">ğŸ  BRANCH</button>
</div>

<div id="addrModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--dark); margin-top:0;">ğŸ¢ BRANCH SETTINGS</h3>
        <input type="text" id="setBranchCode" placeholder="BRANCH CODE" style="width:100%; padding:8px; margin-bottom:10px;">
        <input type="text" id="setAddr1" placeholder="ADDRESS LINE 1" style="width:100%; padding:8px; margin-bottom:10px;">
        <input type="text" id="setAddr3" placeholder="CITY & PINCODE" style="width:100%; padding:8px; margin-bottom:10px;">
        <input type="text" id="setPhone" placeholder="PHONE NO." style="width:100%; padding:8px; margin-bottom:10px;">
        <button class="btn" style="background:var(--success);" onclick="saveAddress()">UPDATE</button>
    </div>
</div>

<div id="docModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="color:var(--primary); margin-top:0;">ğŸ“¦ DOCUMENT ENTRY</h3>
        <input type="text" id="inputBarcode" maxlength="10" placeholder="AWB NO (10 DIGITS)" style="width:100%; padding:12px; margin-bottom:10px; font-size:18px;">
        <input type="text" id="inputName" placeholder="CONSIGNEE NAME" style="width:100%; padding:12px; margin-bottom:10px; font-size:18px;">
        <button class="btn" style="background: var(--success);" onclick="submitEntry()">ADD (ENTER)</button>
        <button class="btn" style="background: #ccc; color: #000;" onclick="closeDocModal()">CLOSE</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    // --- àª¸à«‡àªŸàª¿àª‚àª—à«àª¸: àª…àª¹à«€àª‚ àª¤àª®àª¾àª°à«€ àª²àª¿àª‚àª• àª¨àª¾àª–à«‹ ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycby6znZl4WvqTbxAKPQNyjXVHyjl8quy7GeYBwSw2BBtuIjDtf0qGuZ0p2cZ1xl030yy/execà«‹'; 

    let deliveryData = [];
    let selectedDate = new Date().toISOString().split('T')[0];
    
    // àª²à«‹àª•àª² àª¸à«àªŸà«‹àª°à«‡àªœ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸
    let branchCode = localStorage.getItem("branchCode") || "1100";
    let addrL1 = localStorage.getItem("addrL1") || "SHOP NO. 31 RADHA KRISHNA SOC,";
    let addrL3 = localStorage.getItem("addrL3") || "SURAT - 395007";
    let phoneNum = localStorage.getItem("phoneNum") || "PH: 9137334333";

    function updateDrsDate(val) { selectedDate = val; renderTable(); }

    function validateAndOpenDoc() {
        if(!document.getElementById("deliveryBoy").value.trim() || !document.getElementById("areaName").value.trim()) {
            alert("âš ï¸ àª®àª¹à«‡àª°àª¬àª¾àª¨à«€ àª•àª°à«€àª¨à«‡ BOY àª…àª¨à«‡ AREA àª²àª–à«‹!");
            return;
        }
        document.getElementById("docModal").style.display = "block";
        setTimeout(() => document.getElementById("inputBarcode").focus(), 100);
    }

    function submitEntry() {
        let name = document.getElementById("inputName").value.toUpperCase().trim();
        let barcode = document.getElementById("inputBarcode").value;
        if (name && barcode.length === 10) {
            deliveryData.push({ barcode, name });
            document.getElementById("inputBarcode").value = "";
            document.getElementById("inputName").value = "";
            document.getElementById("inputBarcode").focus();
            renderTable();
        }
    }

    function renderTable() {
        const printArea = document.getElementById("print-area");
        printArea.innerHTML = "";
        const totalPages = Math.ceil(deliveryData.length / 15) || 1;
        
        for (let p = 0; p < totalPages; p++) {
            let div = document.createElement("div");
            div.className = "page-break";
            div.innerHTML = `<div class="header-section">
                <div>
                    <div class="logo-main">SHREE ANJANI</div>
                    <div class="logo-sub">COURIER SERVICES (P) LTD.</div>
                    <div class="addr-line">${addrL1}</div>
                    <div class="addr-bold">${addrL3}</div>
                    <div class="addr-line">${phoneNum}</div>
                </div>
                <div class="drs-info">
                    <div class="drs-title">DELIVERY VOUCHER</div>
                    <div><b>DATE:</b> ${selectedDate}</div>
                    <div><b>AREA:</b> ${document.getElementById("areaName").value}</div>
                    <div><b>BOY:</b> ${document.getElementById("deliveryBoy").value}</div>
                </div>
            </div>
            <table>
                <thead><tr><th class="col-no">NO.</th><th>NAME</th><th class="col-awb">AWB NO.</th><th class="col-sign">SIGNATURE</th></tr></thead>
                <tbody id="rows-page-${p}"></tbody>
            </table>`;
            printArea.appendChild(div);
            
            let tbody = document.getElementById(`rows-page-${p}`);
            let pageItems = deliveryData.slice(p * 15, (p + 1) * 15);
            pageItems.forEach((item, j) => {
                let row = tbody.insertRow();
                let idx = (p * 15) + j;
                row.innerHTML = `<td class="col-no">${idx+1}</td><td>${item.name}</td>
                    <td class="col-awb">${item.barcode}<svg id="b-${idx}" style="height:20px;"></svg></td><td class="col-sign"></td>`;
                JsBarcode(`#b-${idx}`, item.barcode, {format:"CODE128", width:1.1, height:20, displayValue:false});
            });
        }
    }

    // --- Google Sheet àª®àª¾àª‚ àª¸à«‡àªµ àª•àª°àªµàª¾àª¨à«àª‚ àª«àª‚àª•à«àª¶àª¨ ---
    async function saveToCloud() {
        if (deliveryData.length === 0) { alert("àªàª¨à«àªŸà«àª°à«€ àª–àª¾àª²à«€ àª›à«‡!"); return; }
        if (scriptURL.includes('àª…àª¹à«€àª‚_àª¤àª®àª¾àª°à«€')) { alert("àªªàª¹à«‡àª²àª¾ Google Script URL àª¸à«‡àªŸ àª•àª°à«‹!"); return; }

        const saveBtn = document.getElementById("saveBtn");
        saveBtn.innerText = "â³ SAVING...";
        saveBtn.style.opacity = "0.5";

        const payload = {
            date: selectedDate,
            boy: document.getElementById("deliveryBoy").value,
            area: document.getElementById("areaName").value,
            items: deliveryData
        };

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            alert("âœ… Google Sheet àª®àª¾àª‚ àª¸àª«àª³àª¤àª¾àªªà«‚àª°à«àªµàª• àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«àª‚!");
            deliveryData = [];
            renderTable();
        } catch (e) {
            alert("âŒ àª­à«‚àª² àª†àªµà«€: " + e.message);
        } finally {
            saveBtn.innerText = "â˜ï¸ SAVE TO GOOGLE SHEET";
            saveBtn.style.opacity = "1";
        }
    }

    function openAddrModal() { document.getElementById("addrModal").style.display = "block"; }
    function closeDocModal() { document.getElementById("docModal").style.display = "none"; }
    function saveAddress() {
        localStorage.setItem("addrL1", document.getElementById("setAddr1").value);
        localStorage.setItem("addrL3", document.getElementById("setAddr3").value);
        localStorage.setItem("phoneNum", document.getElementById("setPhone").value);
        location.reload();
    }

    window.onload = renderTable;
</script>
</body>
</html>
