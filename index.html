<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Anjani Courier - Pro Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --primary: #f37021; --secondary: #2196F3; --danger: #ff4d4d; --success: #4CAF50; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #ecf0f1; text-transform: uppercase; }
        input, select { text-transform: uppercase; }

        .top-info { background: var(--dark); color: white; padding: 12px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .top-info input, .top-info select { padding: 8px; border-radius: 4px; border: 1px solid #555; width: 180px; background: #34495e; color: white; }

        .no-print { padding: 12px; text-align: center; background: #fff; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .page-break { width: 210mm; height: 297mm; padding: 8mm 10mm; margin: 15px auto; background: white; box-sizing: border-box; border: 1px solid #ccc; page-break-after: always; overflow: hidden; position: relative; }
        
        .header-section { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 5px; }
        .logo-main { font-size: 28px; font-weight: bold; font-style: italic; color: #000; line-height: 1; }
        .logo-sub { font-size: 13px; font-weight: bold; border-top: 2px solid #000; display: inline-block; margin-top: 2px; }
        
        .addr-line { font-size: 10px; font-weight: normal; display: block; margin-top: 1px; }
        .addr-bold { font-size: 10.5px; font-weight: bold; display: block; margin-top: 1px; }

        .drs-info { width: 42%; font-size: 13px; line-height: 1.4; }
        .drs-title { font-weight: bold; font-size: 18px; text-decoration: underline; margin-bottom: 2px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1.5px solid #000; padding: 4px 6px; text-align: left; overflow: hidden; }
        th { background-color: #f2f2f2; font-size: 11px; text-align: center; height: 25px; }
        td { height: 50px; font-size: 13.5px; font-weight: bold; position: relative; word-wrap: break-word; }
        
        .col-no { width: 30px; text-align: center; }
        .col-awb { width: 130px; text-align: center; }
        .col-sign { width: 250px; }

        .row-actions { position: absolute; right: 2px; top: 2px; display: none; gap: 2px; background: rgba(255,255,255,0.9); padding: 2px; border-radius: 4px; }
        tr:hover .row-actions { display: flex; }
        .action-btn { padding: 4px 8px; font-size: 12px; cursor: pointer; border: none; border-radius: 3px; color: white; }

        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 450px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-top: 8px solid var(--primary); }
        
        .btn { padding: 10px 18px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; color: white; font-size: 13px; transition: 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .search-box { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 5px; border: 1px solid #ddd; }
        .search-box input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        @media print {
            .no-print, .modal, .top-info, .row-actions { display: none !important; }
            .page-break { margin: 0; border: none; width: 100%; box-shadow: none; padding: 8mm 10mm; height: 297mm; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<div class="top-info">
    DATE: <input type="date" id="drsDatePicker" onchange="updateDrsDate(this.value)">
    BOY: <input type="text" id="deliveryBoy" list="boyList" placeholder="NAME" oninput="updateLists()">
    <datalist id="boyList"></datalist>
    AREA: <input type="text" id="areaName" list="areaList" placeholder="AREA" oninput="updateLists()">
    <datalist id="areaList"></datalist>
</div>

<div class="no-print">
    <button class="btn" style="background: var(--secondary);" onclick="validateAndOpenDoc()">+ ADD DOC</button>
    <button class="btn" id="saveCloudBtn" style="background: var(--success);" onclick="saveToCloud()">‚òÅÔ∏è SAVE TO CLOUD</button>
    <button class="btn" style="background: var(--primary);" onclick="window.print()">üñ®Ô∏è PRINT</button>
    <button class="btn" style="background: #9b59b6;" onclick="showHistory()">üìú HISTORY</button>
    <button class="btn" style="background: #e67e22;" onclick="openMasterModal()">‚öôÔ∏è MASTER</button>
    <button class="btn" style="background: #546e7a;" onclick="openAddrModal()">üè† BRANCH</button>
    <button class="btn" style="background: var(--danger);" onclick="resetAll()">üîÑ CLEAR</button>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content" style="width: 600px; max-height: 80vh; overflow-y: auto;">
        <h3>üìú DRS HISTORY (LOCAL)</h3>
        <div id="historyList"></div>
        <button class="btn" style="background:#ccc; color:black; width:100%; margin-top:10px;" onclick="closeModal('historyModal')">CLOSE</button>
    </div>
</div>

<div id="masterModal" class="modal">
    <div class="modal-content">
        <h3>‚öôÔ∏è MASTER SETTINGS</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div style="flex:1;">
                <label>BOYS (Comma separated)</label>
                <textarea id="masterBoys" style="width:100%; height:100px;"></textarea>
            </div>
            <div style="flex:1;">
                <label>AREAS (Comma separated)</label>
                <textarea id="masterAreas" style="width:100%; height:100px;"></textarea>
            </div>
        </div>
        <button class="btn" style="background:var(--success); width:100%;" onclick="saveMaster()">SAVE MASTER</button>
    </div>
</div>

<div id="addrModal" class="modal">
    <div class="modal-content">
        <h3>üè¢ BRANCH SETTINGS</h3>
        <input type="text" id="setAddr1" placeholder="ADDRESS LINE 1" style="width:100%; margin-bottom:10px; padding:8px;">
        <input type="text" id="setAddr3" placeholder="CITY & PINCODE" style="width:100%; margin-bottom:10px; padding:8px;">
        <input type="text" id="setPhone" placeholder="PHONE NO." style="width:100%; margin-bottom:10px; padding:8px;">
        <button class="btn" style="background:var(--success); width:100%;" onclick="saveAddress()">UPDATE</button>
    </div>
</div>

<div id="docModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">üì¶ DOCUMENT ENTRY</h3>
        <div class="search-box">
            <input type="text" id="trackInput" placeholder="SEARCH IN HISTORY...">
            <button class="btn" style="background:var(--secondary);" onclick="searchAWB()">üîç</button>
        </div>
        <input type="text" id="inputBarcode" maxlength="10" placeholder="AWB NO (10 DIGITS)" style="width:100%; padding:12px; margin-bottom:10px; font-size:18px;">
        <input type="text" id="inputName" placeholder="CONSIGNEE NAME" style="width:100%; padding:12px; margin-bottom:10px; font-size:18px;">
        <button class="btn" style="background: var(--success); width:100%; height:50px;" onclick="submitEntry()">ADD (ENTER)</button>
        <button class="btn" style="background: #eee; color: #333; width:100%; margin-top:10px;" onclick="closeDocModal()">CANCEL</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    // --- CONFIGURATION ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycby6znZl4WvqTbxAKPQNyjXVHyjl8quy7GeYBwSw2BBtuIjDtf0qGuZ0p2cZ1xl030yy/exec'; 

    let deliveryData = [];
    let drsHistory = JSON.parse(localStorage.getItem("drsHistory") || "[]");
    let selectedDate = new Date().toISOString().split('T')[0];
    document.getElementById("drsDatePicker").value = selectedDate;

    let addrL1 = localStorage.getItem("addrL1") || "SHOP NO. 31 RADHA KRISHNA SOC,";
    let addrL3 = localStorage.getItem("addrL3") || "SURAT - 395007";
    let phoneNum = localStorage.getItem("phoneNum") || "PH: 9137334333";

    function updateDrsDate(val) { selectedDate = val; renderTable(); }

    function validateAndOpenDoc() {
        if(!document.getElementById("deliveryBoy").value.trim() || !document.getElementById("areaName").value.trim()) {
            alert("PAHELA BOY ANE AREA LAKHO!"); return;
        }
        document.getElementById("docModal").style.display = "block";
        document.getElementById("inputBarcode").focus();
    }

    function submitEntry() {
        let name = document.getElementById("inputName").value.toUpperCase().trim();
        let barcode = document.getElementById("inputBarcode").value;
        if (name && barcode.length === 10) {
            deliveryData.push({ barcode, name });
            document.getElementById("inputBarcode").value = "";
            document.getElementById("inputName").value = "";
            document.getElementById("inputBarcode").focus();
            renderTable();
        }
    }

    function renderTable() {
        const printArea = document.getElementById("print-area");
        printArea.innerHTML = "";
        if(deliveryData.length === 0 && !document.getElementById("deliveryBoy").value) return;

        const totalPages = Math.ceil(deliveryData.length / 15) || 1;
        for (let p = 0; p < totalPages; p++) {
            let div = document.createElement("div");
            div.className = "page-break";
            div.innerHTML = `
            <div class="header-section">
                <div>
                    <div class="logo-main">SHREE ANJANI</div>
                    <div class="logo-sub">COURIER SERVICES (P) LTD.</div>
                    <div class="addr-line">${addrL1}</div>
                    <div class="addr-bold">${addrL3}</div>
                    <div class="addr-line">${phoneNum}</div>
                </div>
                <div class="drs-info">
                    <div class="drs-title">DELIVERY VOUCHER</div>
                    <div><b>DATE:</b> ${selectedDate}</div>
                    <div><b>AREA:</b> ${document.getElementById("areaName").value}</div>
                    <div><b>BOY:</b> ${document.getElementById("deliveryBoy").value}</div>
                </div>
            </div>
            <table>
                <thead><tr><th class="col-no">NO.</th><th>NAME</th><th class="col-awb">AWB NO.</th><th class="col-sign">SIGNATURE</th></tr></thead>
                <tbody id="rows-page-${p}"></tbody>
            </table>`;
            printArea.appendChild(div);
            
            let tbody = document.getElementById(`rows-page-${p}`);
            let pageItems = deliveryData.slice(p * 15, (p + 1) * 15);
            pageItems.forEach((item, j) => {
                let realIdx = (p * 15) + j;
                let row = tbody.insertRow();
                row.innerHTML = `<td class="col-no">${realIdx+1}</td><td>${item.name}</td>
                    <td class="col-awb">${item.barcode}<svg id="b-${realIdx}" style="height:20px;"></svg>
                    <div class="row-actions no-print"><button class="action-btn" style="background:var(--secondary)" onclick="editEntry(${realIdx})">‚úé</button>
                    <button class="action-btn" style="background:var(--danger)" onclick="deleteEntry(${realIdx})">‚úï</button></div></td><td class="col-sign"></td>`;
                JsBarcode(`#b-${realIdx}`, item.barcode, {format:"CODE128", width:1.1, height:20, displayValue:false});
            });
        }
    }

    async function saveToCloud() {
        if (deliveryData.length === 0) { alert("DATA NATHI!"); return; }
        
        const entry = {
            drsNo: Date.now(),
            date: selectedDate,
            boy: document.getElementById("deliveryBoy").value,
            area: document.getElementById("areaName").value,
            items: [...deliveryData]
        };

        // Local Save
        drsHistory.unshift(entry);
        localStorage.setItem("drsHistory", JSON.stringify(drsHistory.slice(0, 50)));

        // Cloud Save
        if (scriptURL && !scriptURL.includes('TARI_GOOGLE')) {
            document.getElementById("saveCloudBtn").innerText = "‚è≥ SAVING...";
            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
                alert("DONE! CLOUD & LOCAL BOTH SAVED.");
            } catch (e) { alert("CLOUD ERROR BUT LOCAL SAVED."); }
            document.getElementById("saveCloudBtn").innerText = "‚òÅÔ∏è SAVE TO CLOUD";
        } else { alert("LOCAL HISTORY MA SAVE THAI GAYU!"); }
    }

    function showHistory() {
        document.getElementById("historyModal").style.display = "block";
        const list = document.getElementById("historyList");
        list.innerHTML = drsHistory.map(h => `
            <div style="border:1px solid #ddd; padding:8px; margin-bottom:5px; display:flex; justify-content:space-between;">
                <span><b>${h.date}</b> - ${h.boy} (${h.items.length} PKT)</span>
                <button onclick="loadHistory(${h.drsNo})">LOAD</button>
            </div>`).join('') || "NO HISTORY";
    }

    function loadHistory(drsNo) {
        const h = drsHistory.find(x => x.drsNo === drsNo);
        if(h) {
            deliveryData = [...h.items];
            document.getElementById("deliveryBoy").value = h.boy;
            document.getElementById("areaName").value = h.area;
            renderTable(); closeModal('historyModal');
        }
    }

    function searchAWB() {
        const val = document.getElementById("trackInput").value;
        for(let h of drsHistory) {
            let found = h.items.find(i => i.barcode.includes(val));
            if(found) { document.getElementById("inputName").value = found.name; document.getElementById("inputBarcode").value = found.barcode; return; }
        }
    }

    function editEntry(idx) {
        let item = deliveryData[idx];
        document.getElementById("inputBarcode").value = item.barcode;
        document.getElementById("inputName").value = item.name;
        deliveryData.splice(idx, 1);
        document.getElementById("docModal").style.display = "block";
        renderTable();
    }

    function deleteEntry(idx) { if(confirm("DELETE?")) { deliveryData.splice(idx, 1); renderTable(); } }
    function resetAll() { if(confirm("CLEAR ALL?")) { deliveryData = []; renderTable(); } }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function closeDocModal() { closeModal('docModal'); renderTable(); }
    function openMasterModal() { document.getElementById("masterModal").style.display = "block"; document.getElementById("masterBoys").value = localStorage.getItem("masterBoys") || ""; document.getElementById("masterAreas").value = localStorage.getItem("masterAreas") || ""; }
    function saveMaster() { localStorage.setItem("masterBoys", document.getElementById("masterBoys").value); localStorage.setItem("masterAreas", document.getElementById("masterAreas").value); updateLists(); closeModal('masterModal'); }
    function updateLists() {
        const boys = (localStorage.getItem("masterBoys") || "").split(",").map(s => s.trim());
        const areas = (localStorage.getItem("masterAreas") || "").split(",").map(s => s.trim());
        document.getElementById("boyList").innerHTML = boys.map(b => `<option value="${b}">`).join('');
        document.getElementById("areaList").innerHTML = areas.map(a => `<option value="${a}">`).join('');
    }
    function openAddrModal() { document.getElementById("addrModal").style.display = "block"; document.getElementById("setAddr1").value = addrL1; document.getElementById("setAddr3").value = addrL3; document.getElementById("setPhone").value = phoneNum; }
    function saveAddress() { localStorage.setItem("addrL1", document.getElementById("setAddr1").value); localStorage.setItem("addrL3", document.getElementById("setAddr3").value); localStorage.setItem("phoneNum", document.getElementById("setPhone").value); location.reload(); }

    window.onload = () => { updateLists(); renderTable(); };
    document.addEventListener("keydown", (e) => { if(e.key === "Enter" && document.getElementById("docModal").style.display === "block") submitEntry(); });
</script>
</body>
</html>
